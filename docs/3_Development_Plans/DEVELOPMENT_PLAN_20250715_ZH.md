# Gemini Balance Next.js 下一阶段开发计划 (2025-07-15)

**制定人**: Cline (系统分析师)
**状态**: 待执行

## 1. 总体目标

本开发计划旨在将 `gemini-balance-nextjs` 项目从当前的原型阶段推进到安全、稳定、功能完整的生产可用状态。我们将遵循一个分阶段的方法，首先解决严重的安全漏洞，然后补全核心功能，最后进行功能扩展和体验优化。

## 2. 优先级定义

- **P0 - 阻塞级 (Blocker):** 严重的安全漏洞或功能缺陷，导致系统完全不可用或极度危险。必须在任何其他开发之前立即修复。
- **P1 - 高优先级 (High):** 缺失核心功能，这些功能是项目存在的核心价值。直接影响产品的核心竞争力和高可用性。
- **P2 - 中优先级 (Medium):** 重要的功能完善、架构重构或开发者体验改进。能显著提升产品质量和可维护性。
- **P3 - 低优先级 (Low):** 功能增强、UI/UX 优化或次要的功能实现。属于锦上添花，可在核心功能稳定后进行。

---

## 3. 开发任务清单与优先级

### 阶段一：安全与稳定性修复 (P0 - 阻塞级)

_此阶段的目标是堵上所有已知的安全漏洞，确保服务的基本安全。_

| 优先级 | 任务名称                        | 任务描述 -                                                                                                                                                                                                                                                                                                                                 |
| :----: | :------------------------------ | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **P0** | **修复 API 路由未受保护的问题** | **问题**: `src/middleware.ts` 中认证逻辑被注释，所有 API 端点 (`/gemini/*`, `/openai/*`) 完全公开。<br>**方案**: 在每个 API 路由处理器（如 `chat/completions/route.ts`）的入口处，添加强制性的授权验证逻辑。验证逻辑需检查 `Authorization` 头或 `key` 查询参数，并与数据库中的 `ApiKey` 或环境变量 `ALLOWED_TOKENS` 进行比对。 -           |
| **P0** | **实现真正的用户认证系统**      | **问题**: UI 认证使用硬编码的共享令牌 (`AUTH_TOKEN`)，极不安全。<br>**方案**: 1. 在 `prisma/schema.prisma` 中添加 `User` 模型，包含 `username` 和 `hashedPassword`。 2. 引入 `lucia-auth` 或 `next-auth`，构建标准的、基于数据库的用户注册和登录流程。 3. 使用 `bcrypt` 对密码进行哈希存储和验证。 4. 废弃现有的 `AUTH_TOKEN` 环境变量。 - |

### 阶段二：核心功能补全 (P1 - 高优先级)

_此阶段的目标是实现项目提案中的核心功能，使其成为一个真正高可用的 AI 网关。_

| 优先级 | 任务名称                        | 任务描述 -                                                                                                                                                                                                                                                                                                                 |
| :----: | :------------------------------ | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **P1** | **实现 API 请求的自动失败重试** | **问题**: 当前请求失败后直接返回错误，未利用多 Key 优势。<br>**方案**: 修改 `src/lib/gemini-proxy.ts`，增加一个重试循环逻辑。当捕获到可重试的 API 错误时，自动从 `KeyManager` 获取下一个可用密钥并发起重试，直到成功或达到最大重试次数。 -                                                                                 |
| **P1** | **完善 OpenAI 兼容层**          | **问题**: 请求转换逻辑不完整。<br>**方案**: 1. 在 `src/lib/google-adapter.ts` 的 `adaptOpenAIRequestToGemini` 函数中，增加对 `system` 角色的正确处理逻辑。 2. 增加对多模态内容（`content` 数组中的 `image_url`）的转换支持。 -                                                                                             |
| **P1** | **重构并统一认证逻辑**          | **问题**: 认证逻辑分散在 `middleware.ts` 和 `page.tsx` 中，混乱且重复。<br>**方案**: 在 P0 的新认证系统基础上进行重构。1. `middleware.ts` 只负责检查会话是否存在并重定向到登录页。 2. 在根布局（如 `/admin/layout.tsx`）中进行会话的有效性验证。 3. 使用 React Context 或 zustand 等状态管理库在客户端共享用户登录状态。 - |

### 阶段三：功能扩展与体验优化 (P2 & P3)

_此阶段的目标是逐步实现高级功能，并对现有功能进行打磨，提升整体产品质量。_

| 优先级 | 任务名称                       | 任务描述 -                                                                                                                                                                                                                                                                                                     |
| :----: | :----------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **P2** | **实现高级模型处理逻辑**       | **问题**: 未实现对特殊模型后缀的处理。<br>**方案**: 1. 实现对 `-search` 后缀模型的识别和相应的联网搜索逻辑。 2. 实现对 `-image` 后缀模型的识别和调用 `imagen` 服务的逻辑。 3. 在 OpenAI 兼容层中添加对 `tools` (Function Calling) 参数的适配。 -                                                               |
| **P2** | **修复并规范化数据库迁移脚本** | **问题**: `package.json` 中的 `db:migrate` 脚本损坏且具有误导性。<br>**方案**: 1. 将 `package.json` 中的 `db:migrate` 脚本修改为 `"prisma migrate dev"`。 2. 在 `README.md` 中明确记录开发环境 (`prisma migrate dev`) 和生产环境 (`prisma migrate deploy`) 的不同迁移命令和流程。 -                            |
| **P3** | **增强管理后台功能**           | **问题**: 日志查询功能过于基础。<br>**方案**: 1. 在 `/admin/logs` 页面增加对 `ErrorLog` 的查询和展示。 2. 为日志查看器增加分页和关键词搜索功能。 -                                                                                                                                                             |
| **P3** | **UI/UX 和代码质量打磨**       | **问题**: 默认元数据、临时欢迎页、日志噪音等。<br>**方案**: 1. 更新 `src/app/layout.tsx` 中的 `metadata`，提供有意义的标题和描述。 2. 为登录后的用户设计一个真正的仪表盘页面。 3. 全面使用 `pino` 进行日志记录，并移除所有临时的 `console.log`。 4. 将 `key-manager.ts` 中硬编码的健康检查模型改为可配置项。 - |
