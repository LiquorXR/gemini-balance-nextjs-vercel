# `gemini-balance` (Python 参考项目) 项目说明书

## 1. 项目概述

`gemini-balance` 是一个使用 Python FastAPI 框架构建的 Google Gemini API 代理和负载均衡器。它旨在为开发者提供一个功能丰富、可高度配置的 AI 网关，不仅能代理 Gemini API 请求，还兼容 OpenAI API 格式，并集成了一系列高级功能以提升服务的可用性、可管理性和可观察性。

## 2. 核心实现

核心功能围绕着 API 代理和密钥管理展开，确保高效、可靠地将客户端请求转发到 Google Gemini 服务。

- **多密钥负载均衡**:
  - 支持配置一个或多个 Gemini API 密钥池。
  - 采用轮询（Round-Robin）机制，将请求依次分配给池中的密钥，以分摊负载。
- **双协议 API 兼容**:
  - 提供兼容 OpenAI `v1/chat/completions` 的 API 端点，允许现有生态系统中的工具无缝接入。
  - 同时提供原生 Gemini API 的代理端点 (`v1beta/models/{model}:generateContent`)。
- **故障转移与重试**:
  - 当使用某个密钥的 API 请求失败时，系统会自动进行重试（可配置重试次数）。
  - 重试时会自动切换到下一个可用的密钥，增强了服务的容错能力。
- **密钥健康状态管理**:
  - 持续监控每个密钥的连续失败次数。
  - 当某个密钥的失败次数超过预设阈值时，会将其暂时从可用池中移除。
  - 系统会按设定的时间间隔，定期检查被禁用密钥的恢复情况，并在其恢复正常后重新加入服务池。
- **流式响应支持**:
  - 完全支持 Gemini 和 OpenAI 格式的流式响应，适用于实时聊天等应用场景。

## 3. 辅助功能

除了核心的代理和负载均衡能力，项目还提供了大量辅助功能，极大地扩展了其应用场景和易用性。

- **可视化管理后台**:
  - 提供 Web UI 界面，用于实时查看和修改系统配置，配置可即时生效，无需重启服务。
  - 提供密钥状态监控页面 (`/keys_status`)，实时展示每个密钥的状态、使用情况。
  - 提供详细的错误日志查看界面，方便快速定位和解决问题。
- **高级模型功能支持**:
  - **图文对话与图片修改**: 特定模型支持图文混合输入和图片编辑功能。
  - **网页搜索**: 特定模型支持在生成内容前进行网络搜索，以获取最新信息。
  - **文本转语音 (TTS)**: 支持调用 TTS 模型生成语音。
  - **图像生成**: 兼容 OpenAI 的图像生成 API，并支持将生成的图片上传到多种图床（SM.MS, PicGo, Cloudflare）。
- **灵活的配置与扩展**:
  - **模型管理**: 支持自动获取和维护模型列表，并允许通过配置过滤掉不需要的模型。
  - **网络代理**: 支持配置 HTTP/SOCKS5 代理，以适应特殊的网络环境。
  - **数据库支持**: 支持使用 MySQL 或 SQLite 存储日志和配置信息。
  - **日志管理**: 详细的请求和错误日志记录，并支持自动清理过期日志。
  - **Docker 化部署**: 提供 Dockerfile 和预构建的 Docker 镜像，支持快速、跨平台的部署。

## 4. 项目结构

项目采用模块化的结构，职责清晰，易于维护和扩展。

```
app/
├── config/       # 配置管理
├── core/         # 应用核心逻辑
├── database/     # 数据库模型与连接
├── handler/      # 请求处理器
├── middleware/   # 中间件
├── router/       # API 路由
├── scheduler/    # 定时任务
├── service/      # 业务逻辑服务
├── static/       # 静态文件 (CSS, JS)
├── templates/    # HTML 模板
└── main.py       # 应用入口
```
